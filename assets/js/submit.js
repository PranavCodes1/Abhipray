// ===== Language strings for submit page =====
const submitI18n = {
    en: {
        // Site meta
        "site.title": "Submit Abhipray — Sawai Gandharva Festival",
        // Page content
        "submit.title": "Submit Your Abhipray",
        "submit.subtitle": "Share your experience and memories from the Sawai Gandharva Bhimsen Mahotsav",
        // Submission type
        "submit.type.title": "How would you like to submit?",
        "submit.type.text.title": "Type Your Abhipray",
        "submit.type.text.desc": "Write your experience directly in the form",
        "submit.type.image.title": "Upload Handwritten",
        "submit.type.image.desc": "Upload a photo/scan of your handwritten abhipray",
        // Personal information
        "submit.personal.title": "Personal Information",
        "submit.fields.name": "Full Name *",
        "submit.fields.phone": "Phone Number *",
        "submit.fields.email": "Email Address",
        "submit.fields.years": "Years of Festival Experience",
        "submit.fields.years.help": "How many years have you been attending?",
        "submit.fields.years.placeholder": "e.g. 5",
        "submit.fields.address": "Address",
        "submit.fields.address.placeholder": "City, State, Country",
        // Validation messages
        "submit.validation.name": "Please provide your full name.",
        "submit.validation.phone": "Please provide a valid phone number.",
        "submit.validation.email": "Please provide a valid email address.",
        "submit.validation.language": "Please select the language of your abhipray.",
        // Music interests
        "submit.interests.title": "Interests in Music",
        "submit.interests.vocal": "Vocal",
        "submit.interests.instrumental": "Instrumental",
        "submit.interests.dance": "Dance",
        // Content submission
        "submit.content.title": "Your Abhipray",
        "submit.content.language.label": "Language of your Abhipray",
        "submit.content.language.select": "Select Language",
        "submit.content.language.marathi": "Marathi",
        "submit.content.language.hindi": "Hindi", 
        "submit.content.language.english": "English",
        "submit.content.language.mixed": "Other Language",
        "submit.content.text.label": "Share your experience and thoughts",
        "submit.content.text.placeholder": "Write your experience, memories, or thoughts about the festival in your preferred language (Marathi, Hindi, or English)...",
        "submit.content.text.help": "Write in any language - Marathi, Hindi, or English",
        "submit.content.image.label": "Upload your handwritten abhipray",
        "submit.content.image.help": "Upload a clear photo or scan of your handwritten abhipray (JPG, PNG, PDF - Max 5MB)",
        "submit.content.image.remove": "Remove Image",
        // Submit button
        "submit.button": "Submit Abhipray",
        // Success modal
        "success.title": "Thank You!",
        "success.heading": "Successfully Submitted!",
        "success.message": "Your abhipray has been submitted successfully. Thank you for sharing your experience with us!",
        "success.homepage": "Homepage",
        "success.exploreAbhipray": "Explore Abhipray"
    },
    hi: {
        // Site meta
        "site.title": "अभिप्राय भेजें — सवाई गंधर्व महोत्सव",
        // Page content
        "submit.title": "अपना अभिप्राय भेजें",
        "submit.subtitle": "सवाई गंधर्व भीमसेन महोत्सव से अपने अनुभव और यादें साझा करें",
        // Submission type
        "submit.type.title": "आप कैसे भेजना चाहते हैं?",
        "submit.type.text.title": "अभिप्राय टाइप करें",
        "submit.type.text.desc": "फॉर्म में सीधे अपना अनुभव लिखें",
        "submit.type.image.title": "हस्तलिखित अपलोड करें",
        "submit.type.image.desc": "अपने हस्तलिखित अभिप्राय की फोटो/स्कैन अपलोड करें",
        // Personal information
        "submit.personal.title": "व्यक्तिगत जानकारी",
        "submit.fields.name": "पूरा नाम *",
        "submit.fields.phone": "फोन नंबर *",
        "submit.fields.email": "ईमेल पता",
        "submit.fields.years": "महोत्सव का अनुभव (वर्ष)",
        "submit.fields.years.help": "आप कितने वर्षों से उपस्थित हो रहे हैं?",
        "submit.fields.years.placeholder": "जैसे 5",
        "submit.fields.address": "पता",
        "submit.fields.address.placeholder": "शहर, राज्य, देश",
        // Validation messages
        "submit.validation.name": "कृपया अपना पूरा नाम दें।",
        "submit.validation.phone": "कृपया एक वैध फोन नंबर दें।",
        "submit.validation.email": "कृपया एक वैध ईमेल पता दें।",
        "submit.validation.language": "कृपया अपने अभिप्राय की भाषा चुनें।",
        // Music interests
        "submit.interests.title": "संगीत में रुचि",
        "submit.interests.vocal": "गायन",
        "submit.interests.instrumental": "वाद्य",
        "submit.interests.dance": "नृत्य",
        // Content submission
        "submit.content.title": "आपका अभिप्राय",
        "submit.content.language.label": "आपके अभिप्राय की भाषा",
        "submit.content.language.select": "भाषा चुनें",
        "submit.content.language.marathi": "मराठी",
        "submit.content.language.hindi": "हिंदी",
        "submit.content.language.english": "अंग्रेजी", 
        "submit.content.language.mixed": "अन्य भाषा",
        "submit.content.text.label": "अपने अनुभव और विचार साझा करें",
        "submit.content.text.placeholder": "महोत्सव के बारे में अपने अनुभव, यादें या विचार अपनी पसंदीदा भाषा में लिखें (मराठी, हिंदी या अंग्रेजी)...",
        "submit.content.text.help": "किसी भी भाषा में लिखें - मराठी, हिंदी या अंग्रेजी",
        "submit.content.image.label": "अपना हस्तलिखित अभिप्राय अपलोड करें",
        "submit.content.image.help": "अपने हस्तलिखित अभिप्राय की स्पष्ट फोटो या स्कैन अपलोड करें (JPG, PNG, PDF - अधिकतम 5MB)",
        "submit.content.image.remove": "छवि हटाएं",
        // Submit button
        "submit.button": "अभिप्राय भेजें",
        // Success modal
        "success.title": "धन्यवाद!",
        "success.heading": "सफलतापूर्वक भेजा गया!",
        "success.message": "आपका अभिप्राय सफलतापूर्वक भेज दिया गया है। अपना अनुभव साझा करने के लिए धन्यवाद!",
        "success.homepage": "मुखपृष्ठ",
        "success.exploreAbhipray": "अभिप्राय देखें"
    },
    mr: {
        // Site meta
        "site.title": "अभिप्राय पाठवा — सवाई गंधर्व महोत्सव",
        // Page content
        "submit.title": "आपला अभिप्राय पाठवा",
        "submit.subtitle": "सवाई गंधर्व भीमसेन महोत्सवाचे आपले अनुभव आणि आठवणी शेअर करा",
        // Submission type
        "submit.type.title": "तुम्ही कसे पाठवू इच्छिता?",
        "submit.type.text.title": "अभिप्राय टाइप करा",
        "submit.type.text.desc": "फॉर्ममध्ये थेट आपला अनुभव लिहा",
        "submit.type.image.title": "हस्तलिखित अपलोड करा",
        "submit.type.image.desc": "आपल्या हस्तलिखित अभिप्रायाचा फोटो/स्कॅन अपलोड करा",
        // Personal information
        "submit.personal.title": "वैयक्तिक माहिती",
        "submit.fields.name": "पूर्ण नाव *",
        "submit.fields.phone": "फोन नंबर *",
        "submit.fields.email": "ईमेल पत्ता",
        "submit.fields.years": "महोत्सवाचा अनुभव (वर्षे)",
        "submit.fields.years.help": "तुम्ही किती वर्षांपासून उपस्थित आहात?",
        "submit.fields.years.placeholder": "उदा. 5",
        "submit.fields.address": "पत्ता",
        "submit.fields.address.placeholder": "शहर, राज्य, देश",
        // Validation messages
        "submit.validation.name": "कृपया आपले पूर्ण नाव द्या।",
        "submit.validation.phone": "कृपया वैध फोन नंबर द्या।",
        "submit.validation.email": "कृपया वैध ईमेल पत्ता द्या।",
        "submit.validation.language": "कृपया तुमच्या अभिप्रायाची भाषा निवडा।",
        // Music interests
        "submit.interests.title": "संगीतात स्वारस्य",
        "submit.interests.vocal": "गायन",
        "submit.interests.instrumental": "वाद्य",
        "submit.interests.dance": "नृत्य",
        // Content submission
        "submit.content.title": "तुमचा अभिप्राय",
        "submit.content.language.label": "तुमच्या अभिप्रायाची भाषा",
        "submit.content.language.select": "भाषा निवडा",
        "submit.content.language.marathi": "मराठी",
        "submit.content.language.hindi": "हिंदी",
        "submit.content.language.english": "इंग्रजी",
        "submit.content.language.mixed": "इतर भाषा",
        "submit.content.text.label": "तुमचे अनुभव आणि विचार शेअर करा",
        "submit.content.text.placeholder": "महोत्सवाबद्दल तुमचे अनुभव, आठवणी किंवा विचार तुमच्या आवडत्या भाषेत लिहा (मराठी, हिंदी किंवा इंग्रजी)...",
        "submit.content.text.help": "कोणत्याही भाषेत लिहा - मराठी, हिंदी किंवा इंग्रजी",
        "submit.content.image.label": "तुमचा हस्तलिखित अभिप्राय अपलोड करा",
        "submit.content.image.help": "तुमच्या हस्तलिखित अभिप्रायाचा स्पष्ट फोटो किंवा स्कॅन अपलोड करा (JPG, PNG, PDF - कमाल 5MB)",
        "submit.content.image.remove": "छबी काढा",
        // Submit button
        "submit.button": "अभिप्राय पाठवा",
        // Success modal
        "success.title": "धन्यवाद!",
        "success.heading": "यशस्वीरित्या पाठवले!",
        "success.message": "तुमचा अभिप्राय यशस्वीरित्या पाठवला गेला आहे। तुमचा अनुभव शेअर केल्याबद्दल धन्यवाद!",
        "success.homepage": "मुख्यपृष्ठ",
        "success.exploreAbhipray": "अभिप्राय पहा"
    }
};

// ===== Merge submit translations with main i18n =====
if (typeof i18n !== 'undefined') {
    // Main i18n exists, merge submit page translations
    Object.keys(submitI18n).forEach(lang => {
        if (i18n[lang]) {
            Object.assign(i18n[lang], submitI18n[lang]);
        } else {
            i18n[lang] = submitI18n[lang];
        }
    });
} else {
    // If main i18n doesn't exist, use submit translations
    window.i18n = submitI18n;
}

// ===== Handle submit page specific placeholders =====
function updateSubmitPlaceholders(lang) {
    // Update textarea placeholder
    const abhiprayTextarea = document.getElementById("abhiprayText");
    if (abhiprayTextarea) {
        const placeholderText = i18n[lang]?.["submit.content.text.placeholder"];
        if (placeholderText) {
            abhiprayTextarea.placeholder = placeholderText;
        }
    }

    // Update address placeholder
    const addressTextarea = document.getElementById("address");
    if (addressTextarea) {
        const placeholderText = i18n[lang]?.["submit.fields.address.placeholder"];
        if (placeholderText) {
            addressTextarea.placeholder = placeholderText;
        }
    }

    // Update years attending placeholder
    const yearsInput = document.getElementById("yearsAttending");
    if (yearsInput) {
        const placeholderText = i18n[lang]?.["submit.fields.years.placeholder"];
        if (placeholderText) {
            yearsInput.placeholder = placeholderText;
        }
    }
}

// ===== Enhanced placeholder handling =====
function setupPlaceholderBehavior() {
    const textarea = $("#abhiprayText");
    
    // Ensure the textarea starts empty and has no preset content
    textarea.val("");
    
    // Update placeholder based on current language
    const currentLang = localStorage.getItem("abhipray_lang") || "en";
    updateSubmitPlaceholders(currentLang);
}

// ===== Store original switchLanguage function and extend it =====
let originalSwitchLanguage = null;

// Enhanced language switching for submit page
window.switchLanguage = function(lang) {
    // Call main.js switchLanguage if it exists
    if (typeof window.switchLanguage.original === 'function') {
        window.switchLanguage.original(lang);
    } else {
        // Basic language switching if main.js is not loaded
        if (!i18n[lang]) return;
        localStorage.setItem("abhipray_lang", lang);
        
        // Apply translations
        if (typeof applyTranslations === 'function') {
            applyTranslations(lang);
        } else {
            // Fallback translation application
            document.querySelectorAll("[data-i18n]").forEach(el => {
                const key = el.getAttribute("data-i18n");
                const str = i18n[lang]?.[key];
                if (typeof str === "string") el.textContent = str;
            });
        }
        
        // Set active button
        if (typeof setActiveLangButton === 'function') {
            setActiveLangButton(lang);
        } else {
            // Fallback button highlighting
            $(".lang-btn").removeClass("active");
            $(`.lang-btn[data-lang='${lang}']`).addClass("active");
        }
        
        document.title = i18n[lang]["site.title"] || document.title;
        document.documentElement.lang = lang;
    }
    
    // Update submit page specific placeholders
    updateSubmitPlaceholders(lang);
};

// ===== Enhanced language initialization =====
function ensureLanguageConsistency() {
    const currentLang = localStorage.getItem("abhipray_lang") || "en";
    
    // Wait for DOM and main.js to be ready
    const initLang = () => {
        // Store original switchLanguage if it exists
        if (typeof switchLanguage === 'function' && !window.switchLanguage.original) {
            window.switchLanguage.original = switchLanguage;
        }
        
        // Apply current language
        if (typeof window.switchLanguage === 'function') {
            window.switchLanguage(currentLang);
        }
        
        // Setup language button event handlers
        $(".lang-btn").off("click.submit").on("click.submit", function(){
            const lang = $(this).data("lang");
            window.switchLanguage(lang);
        });
    };
    
    // Try immediate initialization
    initLang();
    
    // Also try after a short delay to ensure main.js is loaded
    setTimeout(initLang, 50);
}

// ===== Submission type toggle functionality =====
function toggleSubmissionType() {
    const textSelected = $("#typeText").is(":checked");
    const imageSelected = $("#typeImage").is(":checked");
    
    if (textSelected) {
        $("#textSubmission").show();
        $("#imageSubmission").hide();
        // Make text required, remove image requirement
        $("#abhiprayText").prop("required", true);
        $("#abhiprayImage").prop("required", false);
    } else if (imageSelected) {
        $("#textSubmission").hide();
        $("#imageSubmission").show();
        // Make image required, remove text requirement
        $("#abhiprayText").prop("required", false);
        $("#abhiprayImage").prop("required", true);
    }
}

// ===== Image preview functionality =====
function handleImagePreview() {
    $("#abhiprayImage").on("change", function(e) {
        const file = e.target.files[0];
        if (file) {
            // Validate file size (5MB limit)
            if (file.size > 5 * 1024 * 1024) {
                alert("File size must be less than 5MB");
                $(this).val("");
                return;
            }

            // Validate file type
            const validTypes = ["image/jpeg", "image/jpg", "image/png", "application/pdf"];
            if (!validTypes.includes(file.type)) {
                alert("Please upload only JPG, PNG, or PDF files");
                $(this).val("");
                return;
            }

            // Show preview for images only
            if (file.type.startsWith("image/")) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    $("#previewImg").attr("src", e.target.result);
                    $("#imagePreview").show();
                };
                reader.readAsDataURL(file);
            } else {
                // For PDF, just show the preview container without image
                $("#previewImg").hide();
                $("#imagePreview").show();
            }
        }
    });

    // Remove image functionality
    $("#removeImage").on("click", function() {
        $("#abhiprayImage").val("");
        $("#imagePreview").hide();
    });
}

// ===== Form validation =====
function validateForm() {
    const form = document.getElementById("abhiprayForm");
    let isValid = true;

    // Clear all previous validation states
    $(form).find(".is-invalid").removeClass("is-invalid");

    // Validate required fields
    const fullName = $("#fullName").val().trim();
    const phone = $("#phone").val().trim();

    if (!fullName) {
        $("#fullName").addClass("is-invalid");
        isValid = false;
    }

    if (!phone) {
        $("#phone").addClass("is-invalid");
        isValid = false;
    }

    // Validate email if provided
    const email = $("#email").val().trim();
    if (email && !isValidEmail(email)) {
        $("#email").addClass("is-invalid");
        isValid = false;
    }

    // Validate content based on submission type
    const textSelected = $("#typeText").is(":checked");
    const imageSelected = $("#typeImage").is(":checked");
    
    // Validate abhipray language selection
    const abhiprayLanguage = $("#abhiprayLanguage").val();
    if (!abhiprayLanguage) {
        $("#abhiprayLanguage").addClass("is-invalid");
        isValid = false;
    }

    if (textSelected) {
        const abhiprayText = $("#abhiprayText").val().trim();
        if (!abhiprayText) {
            $("#abhiprayText").addClass("is-invalid");
            isValid = false;
        }
    } else if (imageSelected) {
        const fileInput = $("#abhiprayImage")[0];
        if (!fileInput.files || fileInput.files.length === 0) {
            $("#abhiprayImage").addClass("is-invalid");
            isValid = false;
        }
    }

    return isValid;
}

function isValidEmail(email) {
    const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
    return emailRegex.test(email);
}

// ===== Form submission =====
function handleFormSubmission() {
    $("#abhiprayForm").on("submit", function(e) {
        e.preventDefault();

        if (!validateForm()) {
            // Show validation errors
            $(".is-invalid").first().focus();
            return;
        }

        // Collect form data
        const formData = new FormData();

        // Personal information
        formData.append("fullName", $("#fullName").val().trim());
        formData.append("phone", $("#phone").val().trim());
        formData.append("email", $("#email").val().trim());
        formData.append("yearsAttending", $("#yearsAttending").val() || "");
        formData.append("address", $("#address").val().trim());

        // Music interests
        const interests = [];
        $("input[name='interests']:checked").each(function() {
            interests.push($(this).val());
        });
        formData.append("interests", interests.join(","));

        // Abhipray language
        formData.append("abhiprayLanguage", $("#abhiprayLanguage").val());

        // Submission type and content
        const submissionType = $("input[name='submissionType']:checked").val();
        formData.append("submissionType", submissionType);

        if (submissionType === "text") {
            formData.append("abhiprayText", $("#abhiprayText").val().trim());
        } else if (submissionType === "image") {
            const fileInput = $("#abhiprayImage")[0];
            if (fileInput.files.length > 0) {
                formData.append("abhiprayImage", fileInput.files[0]);
            }
        }

        // For now, just show success message (replace with actual submission logic in Django)
        showSuccessMessage();
    });
}

function showSuccessMessage() {
    // Show the Bootstrap modal instead of alert
    const successModal = new bootstrap.Modal(document.getElementById('successModal'));
    successModal.show();

    // Reset form
    $("#abhiprayForm")[0].reset();
    $("#imagePreview").hide();
    toggleSubmissionType(); // Reset to default state
}

// ===== Initialize on page load =====
$(function() {
    // IMPORTANT: Initialize language FIRST before other functionality
    const currentLang = localStorage.getItem("abhipray_lang") || "en";
    
    // Apply language immediately
    switchLanguage(currentLang);
    
    // Setup proper placeholder behavior
    setupPlaceholderBehavior();
    
    // Initialize submission type toggle
    $("input[name='submissionType']").on("change", toggleSubmissionType);
    toggleSubmissionType(); // Initialize default state

    // Image preview
    handleImagePreview();

    // Form submission
    handleFormSubmission();

    // Real-time validation
    $("#fullName, #phone").on("blur", function() {
        if ($(this).val().trim()) {
            $(this).removeClass("is-invalid");
        }
    });

    $("#email").on("blur", function() {
        const email = $(this).val().trim();
        if (!email || isValidEmail(email)) {
            $(this).removeClass("is-invalid");
        }
    });
    
    // Language selection validation
    $("#abhiprayLanguage").on("change", function() {
        if ($(this).val()) {
            $(this).removeClass("is-invalid");
        }
    });
});
